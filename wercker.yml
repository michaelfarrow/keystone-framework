box:
  id: node
  tag: 6.9.5
  ports:
    - '80'
    - '3000'
    - '3001'

services:
  - id: mongo
    tag: 3.4.1
    ports:
     - '27017'

dev:
  steps:
    - script:
        name: check local environment
        code: |
          [[ -f ENVIRONMENT_LOCAL || "$(cat ENVIRONMENT_LOCAL.template | xargs)" == "" ]] || ( echo "No ENVIRONMENT_LOCAL present, please create one based on ENVIRONMENT_LOCAL.template" && exit 1 )
        cwd: $WERCKER_ROOT
    - npm-install:
        name: install node dependencies
        options: --no-optional
    - script:
        name: adding tools
        code: |
          ln -s "$WERCKER_ROOT/tools/log" /usr/bin/log
          ln -s "$WERCKER_ROOT/tools/reload" /usr/bin/reload
          ln -s "$WERCKER_ROOT/tools/reload" /usr/bin/restart
    - script:
        name: run
        code: |
          touch /var/log/keystone.log
          touch /var/log/webpack.log
          npm run dev >> /var/log/webpack.log 2>&1 &
          npm run watch >> /var/log/keystone.log 2>&1 &
    - internal/shell:
        code: |
          stty columns $TERMINAL_COLUMNS
          stty rows $TERMINAL_ROWS
          log

build:
  steps:
    - npm-install:
        name: install node dependencies
        options: --no-optional --silent
        cwd: $WERCKER_ROOT/src
    - npm-test:
        name: run tests
        cwd: $WERCKER_ROOT/src
    - script:
        name: run webpack
        code: npm run webpack -- -p
        cwd: $WERCKER_ROOT/src
    - script:
        name: export the application
        code: |
          cp -r src "$WERCKER_OUTPUT_DIR"
          rm -rf "$WERCKER_OUTPUT_DIR/src/public/js"
          rm -rf "$WERCKER_OUTPUT_DIR/src/public/css"
          cp -r dokku "$WERCKER_OUTPUT_DIR"
          # mv "$WERCKER_OUTPUT_DIR/dokku/Dockerfile" "$WERCKER_OUTPUT_DIR/Dockerfile"

push:
  steps:
    - script:
        name: Create environment variables
        code: |
          export APP_REPOSITORY="$REGISTRY_HOST/$REGISTRY_USERNAME/$REGISTRY_IMAGE"
          export APP_REPOSITORY_FULL="$APP_REPOSITORY:$WERCKER_GIT_COMMIT"
    - script:
        name: Move Dokku files
        code: |
          mkdir /app
          mv dokku/nginx.conf.sigil /app/nginx.conf.sigil
          mv dokku/CHECKS /app/CHECKS
          rm -rf dokku
    - internal/docker-push:
        username: $REGISTRY_USERNAME
        password: $REGISTRY_PASSWORD
        tag: $WERCKER_GIT_COMMIT
        repository: $APP_REPOSITORY
        registry: https://$REGISTRY_HOST/v2
        cmd: node /pipeline/source/src/index.js
        ports: "80"
    - add-to-known_hosts:
        hostname: $DOKKU_HOST
    - add-ssh-key:
        keyname: DOKKU_KEY
    - script:
        name: Deploy to Dokku
        code: |
          ssh root@$DOKKU_HOST "docker login -u $REGISTRY_USERNAME -p $REGISTRY_PASSWORD $REGISTRY_HOST && docker pull $APP_REPOSITORY_FULL && docker tag $APP_REPOSITORY_FULL dokku/$DOKKU_APP:$WERCKER_GIT_COMMIT && dokku tags:deploy $DOKKU_APP $WERCKER_GIT_COMMIT"
    # - script:
    #     name: generate kubernetes controller file
    #     code: ./node-controller.yml.sh
    # - script:
    #     name: install gcloud
    #     code: |
    #       curl https://sdk.cloud.google.com | bash
    #       source ~/.bashrc
    # - script:
    #     name: install jq
    #     code: |
    #       wget -O /usr/local/bin/jq https://github.com/stedolan/jq/releases/download/jq-1.5rc1/jq-linux-x86_64-static
    #       chmod a+x /usr/local/bin/jq
    # - script:
    #     name: gcr.io authentication
    #     code: |
    #       gcloud auth activate-refresh-token $GCLOUD_ACCOUNT $GCLOUD_REFRESH_TOKEN
    #       gcloud docker --authorize-only
    #       export GCR_AUTH_TOKEN=$(cat $HOME/.dockercfg | jq --raw-output '.["https://gcr.io"].auth' | base64 --decode | cut -d ':' -f2)
    # - internal/docker-push:
    #     username: _token
    #     password: $GCR_AUTH_TOKEN
    #     repository: gcr.io/$GCR_PROJECT/$GCR_IMAGE
    #     tag: $WERCKER_GIT_COMMIT
    #     registry: https://gcr.io
    #     working-dir: $WERCKER_SOURCE_DIR
    #     cmd: node index.js

deploy:
  steps:
    - add-to-known_hosts:
        hostname: $DOKKU_HOST
    - add-ssh-key:
        keyname: DOKKU_KEY
    - script:
        name: Initialize new repository
        code: |
          rm -rf .git
          git init
          git config --global user.name "wercker"
          git config --global user.email "pleasemailus@wercker.com"
          git remote add dokku dokku@$DOKKU_HOST:$DOKKU_APP
    - script:
        name: Add everything to the repository
        code: |
          git add .
          git commit --quiet -m "Result of deploy $WERCKER_GIT_COMMIT"
    - script:
        name: Push to dokku
        code: |
          git push -f dokku master

  # initialize:
  #   - script:
  #       name: debug
  #       code: cat node-controller.yml
  #
  #   - kubectl:
  #       server: $GCE_SERVER
  #       username: $GCE_USERNAME
  #       password: $GCE_PASSWORD
  #       insecure-skip-tls-verify: true
  #       command: create -f mongo.yml
  #
  #   - kubectl:
  #       server: $GCE_SERVER
  #       username: $GCE_USERNAME
  #       password: $GCE_PASSWORD
  #       insecure-skip-tls-verify: true
  #       command: create -f mongo-service.yml
  #
  #   - kubectl:
  #       server: $GCE_SERVER
  #       username: $GCE_USERNAME
  #       password: $GCE_PASSWORD
  #       insecure-skip-tls-verify: true
  #       command: create -f node-controller.yml
  #
  #   - kubectl:
  #       server: $GCE_SERVER
  #       username: $GCE_USERNAME
  #       password: $GCE_PASSWORD
  #       insecure-skip-tls-verify: true
  #       command: create -f node-service.yml
  #
  # rolling-update:
  #   - kubectl:
  #       server: $GCE_SERVER
  #       username: $GCE_USERNAME
  #       password: $GCE_PASSWORD
  #       insecure-skip-tls-verify: true
  #       command: rolling-update node
  #       image: gcr.io/$GCR_PROJECT/$GCR_IMAGE:$WERCKER_GIT_COMMIT
