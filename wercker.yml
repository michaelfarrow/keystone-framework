box:
  id: node
  tag: 6.9.5

build:
  steps:
    - npm-install:
        name: install node dependencies
        options: --no-optional --silent
        cwd: $WERCKER_ROOT/src
    - npm-test:
        name: run tests
        cwd: $WERCKER_ROOT/src
    - script:
        name: run webpack
        code: npm run webpack -- -p
        cwd: $WERCKER_ROOT/src
    - script:
        name: export the application
        code: |
          cp -r src "$WERCKER_OUTPUT_DIR"
          cp -r dokku "$WERCKER_OUTPUT_DIR"
          mv "$WERCKER_OUTPUT_DIR/dokku/Dockerfile" "$WERCKER_OUTPUT_DIR/Dockerfile"
          cp "$WERCKER_ROOT/tools/healthcheck" "$WERCKER_OUTPUT_DIR/healthcheck"
          rm -rf "$WERCKER_OUTPUT_DIR/src/node_modules"
          rm -rf "$WERCKER_OUTPUT_DIR/src/public/css"
    - npm-install:
        name: install node production dependencies
        options: --no-optional --silent --only=production
        cwd: "$WERCKER_OUTPUT_DIR/src"

deploy-dokku:
  steps:
    - add-to-known_hosts:
        hostname: $DOKKU_HOST
    - add-ssh-key:
        keyname: DOKKU_KEY
    - script:
        name: Initialize new repository
        code: |
          rm -rf .git
          git init
          git config --global user.name "wercker"
          git config --global user.email "pleasemailus@wercker.com"
          git remote add dokku dokku@$DOKKU_HOST:$DOKKU_APP
    - script:
        name: Add everything to the repository
        code: |
          git add .
          git commit --quiet -m "Result of deploy $WERCKER_GIT_COMMIT"
    - script:
        name: Push to dokku
        code: |
          git push -f dokku master

docker-push:
  box:
    id: node
    tag: 6.9.5-alpine
    cmd: /bin/sh
  steps:
    - script:
        name: clean
        code: |
          rm -rf "$WERCKER_ROOT/Dockerfile"
          rm -rf "$WERCKER_ROOT/dokku"
    - script:
        name: add healthcheck
        code: |
          mv "$WERCKER_ROOT/healthcheck" /usr/bin/healthcheck
    - internal/docker-push:
        username: $DOCKER_REGISTRY_USERNAME
        password: $DOCKER_REGISTRY_PASSWORD
        tag: $WERCKER_GIT_COMMIT
        repository: $DOCKER_REGISTRY_REPO
        registry: $DOCKER_REGISTRY
        working-dir: $WERCKER_ROOT/src
        cmd: npm run production
        ports: "80"
    - script:
        name: success
        code: success "image pushed - $DOCKER_REGISTRY_REPO:$WERCKER_GIT_COMMIT"
    # - add-to-known_hosts:
    #     name: add to known hosts
    #     hostname: $DOCKER_SWARM_MANAGER
    # - add-ssh-key:
    #     name: add ssh key
    #     keyname: DOCKER_SWARM_KEY
    # - weyforth/docker-swarm@0.1.1:
    #     name: deploy image
    #     manager: $DOCKER_SWARM_MANAGER
    #     user: $DOCKER_SWARM_USER
    #     service: $DOCKER_SWARM_SERVICE
    #     image: $DOCKER_REGISTRY_REPO
    #     tag: $WERCKER_GIT_COMMIT
